databaseChangeLog:
  - property:
      name: booleanFalse
      value: 0
      dbms: oracle
  - property:
      name: booleanFalse
      value: false
      dbms: postgresql
  - property:
      name: booleanTrue
      value: 1
      dbms: oracle
  - property:
      name: booleanTrue
      value: true
      dbms: postgresql
  - property:
      dbms: oracle
      name: varcharUnit
      value: CHAR
  - property:
      dbms: postgresql
      name: varcharUnit
      value: ''
  - changeSet:
      id: 1664181156088-1
      author: limit
      changes:
        - createTable:
            tableName: not_sm_action
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: name
                  type: varchar(255 ${varcharUnit})
              - column:
                  name: spel
                  type: varchar(255 ${varcharUnit})

        - createTable:
            tableName: not_sm_deferred_events
            columns:
              - column:
                  name: jpa_repository_state_id
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: deferred_events
                  type: varchar(255 ${varcharUnit})

        - createTable:
            tableName: not_sm_guard
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: name
                  type: varchar(255 ${varcharUnit})
              - column:
                  name: spel
                  type: varchar(255 ${varcharUnit})

        - createTable:
            tableName: not_sm_state
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: initial_state
                  type: boolean
              - column:
                  name: kind
                  type: varchar(255)
              - column:
                  name: machine_id
                  type: varchar(255)
              - column:
                  name: region
                  type: varchar(255)
              - column:
                  name: state
                  type: varchar(255)
              - column:
                  name: submachine_id
                  type: varchar(255)
              - column:
                  name: initial_action_id
                  type: bigint
              - column:
                  name: parent_state_id
                  type: bigint

        - createTable:
            tableName: not_sm_state_machine
            columns:
              - column:
                  name: machine_id
                  type: varchar(255 ${varcharUnit})
                  constraints:
                    primaryKey: true
                    nullable: false"
              - column:
                  name: state
                  type: varchar(255 ${varcharUnit})
              - column:
                 name: state_machine_context
                 type: blob

        - createTable:
            tableName: not_sm_transition
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: event
                  type: varchar(255 ${varcharUnit})
              - column:
                  name: kind
                  type: varchar(255 ${varcharUnit})
              - column:
                  name: machine_id
                  type: varchar(255 ${varcharUnit})
              - column:
                  name: guard_id
                  type: bigint
              - column:
                  name: source_id
                  type: bigint
              - column:
                  name: target_id
                  type: bigint

        - createTable:
            tableName: not_sm_state_entry_actions
            columns:
              - column:
                  name: jpa_repository_state_id
                  type: bigint
                  constraints:
                    nullable:false
              - column:
                  name: entry_actions_id
                  type: bigint
                  constraints:
                    nullable: false
        - addPrimaryKey:
            tableName: not_sm_state_entry_actions
            columnNames: jpa_repository_state_id, entry_actions_id
            constraintName: pk_state_entry_actions

        - createTable:
            tableName: not_sm_state_exit_actions
            columns:
              - column:
                  name: jpa_repository_state_id
                  type: bigint
                  constraints:
                    nullable:false
              - column:
                  name: exit_actions_id
                  type: bigint
                  constraints:
                    nullable: false
        - addPrimaryKey:
            tableName: not_sm_state_exit_actions
            columnNames: jpa_repository_state_id, exit_actions_id
            constraintName: pk_exit_entry_actions

        - createTable:
            tableName: not_sm_state_state_actions
            columns:
              - column:
                  name: jpa_repository_state_id
                  type: bigint
                  constraints:
                    nullable:false
              - column:
                  name: state_actions_id
                  type: bigint
                  constraints:
                    nullable: false
        - addPrimaryKey:
            tableName: not_sm_state_state_actions
            columnNames: jpa_repository_state_id, state_actions_id
            constraintName: pk_state_state_actions

        - createTable:
            tableName: not_sm_transition_actions
            columns:
              - column:
                  name: jpa_repository_transition_id
                  type: bigint
                  constraints:
                    nullable:false
              - column:
                  name: actions_id
                  type: bigint
                  constraints:
                    nullable: false
        - addPrimaryKey:
            tableName: not_sm_transition_actions
            columnNames: jpa_repository_transition_id, actions_id
            constraintName: pk_transition_actions

        - addForeignKeyConstraint:
            baseTableName: not_sm_deferred_events
            baseColumnNames: jpa_repository_state_id
            constraintName: fk_state_deferred_events
            referencedTableName: not_sm_state
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: not_sm_state
            baseColumnNames: initial_action_id
            constraintName: fk_state_initial_action
            referencedTableName: not_sm_action
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: not_sm_state
            baseColumnNames: parent_state_id
            constraintName: fk_state_parent_state
            referencedTableName: not_sm_state
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: not_sm_transition
            baseColumnNames: guard_id
            constraintName: fk_transition_guard
            referencedTableName: not_sm_guard
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: not_sm_transition
            baseColumnNames: source_id
            constraintName: fk_transition_source
            referencedTableName: not_sm_state
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: not_sm_transition
            baseColumnNames: target_id
            constraintName: fk_transition_target
            referencedTableName: not_sm_state
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: not_sm_state_entry_actions
            baseColumnNames: entry_actions_id
            constraintName: fk_state_entry_actions_a
            referencedTableName: not_sm_action
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: not_sm_state_entry_actions
            baseColumnNames: jpa_repository_state_id
            constraintName: fk_state_entry_actions_s
            referencedTableName: not_sm_state
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: not_sm_state_exit_actions
            baseColumnNames: exit_actions_id
            constraintName: fk_state_exit_actions_a
            referencedTableName: not_sm_action
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: not_sm_state_exit_actions
            baseColumnNames: jpa_repository_state_id
            constraintName: fk_state_exit_actions_s
            referencedTableName: not_sm_state
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: not_sm_state_state_actions
            baseColumnNames: state_actions_id
            constraintName: fk_state_state_actions_a
            referencedTableName: not_sm_action
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: not_sm_state_state_actions
            baseColumnNames: jpa_repository_state_id
            constraintName: fk_state_state_actions_s
            referencedTableName: not_sm_state
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: not_sm_transition_actions
            baseColumnNames: actions_id
            constraintName: fk_transition_actions_a
            referencedTableName: not_sm_action
            referencedColumnNames: id
        - addForeignKeyConstraint:
            baseTableName: not_sm_transition_actions
            baseColumnNames: jpa_repository_transition_id
            constraintName: fk_transition_actions_t
            referencedTableName: not_sm_transition
            referencedColumnNames: id

        - addUniqueConstraint:
            tableName: not_notificacio_env
            constraintName: not_enviament_ref_uk
            columnNames: notifica_ref

        - renameColumn:
            tableName: not_columnes
            oldColumnName: created_date
            newColumnName: data_enviament
#        - addColumn:
#            tableName: not_notificacio_env
#            columns:
#              - column:
#                  name: sm_estat
#                  type: varchar(64 ${varcharunit})
        - update:
            tableName: not_acl_class
            columns:
              - column:
                  name: class
                  value: es.caib.notib.persist.entity.EntitatEntity
            where: class = 'es.caib.notib.core.entity.EntitatEntity'
        - update:
            tableName: not_acl_class
            columns:
              - column:
                  name: class
                  value: es.caib.notib.persist.entity.OrganGestorEntity
            where: class = 'es.caib.notib.core.entity.OrganGestorEntity'
        - update:
            tableName: not_acl_class
            columns:
              - column:
                  name: class
                  value: es.caib.notib.persist.entity.ProcedimentEntity
            where: class = 'es.caib.notib.core.entity.ProcedimentEntity'
        - update:
            tableName: not_acl_class
            columns:
              - column:
                  name: class
                  value: es.caib.notib.persist.entity.ProcSerOrganEntity
            where: class = 'es.caib.notib.core.entity.ProcSerOrganEntity'
        - insert:
            tableName: not_config
            columns:
              - column:
                  name: key
                  value: es.caib.notib.plugin.dades.usuari.pluginsib.userinformation.keycloak.serverurl
              - column:
                  name: value
                  value:
              - column:
                  name: description
                  value: Url del servidor de keycloak
              - column:
                  name: group_code
                  value: USUARIS
              - column:
                  name: position
                  value: 6
              - column:
                  name: jboss_property
                  value: ${booleanTrue}
              - column:
                  name: type_code
                  value: TEXT
              - column:
                  name: configurable
                  value: ${booleanFalse}
        - insert:
            tableName: not_config
            columns:
              - column:
                  name: key
                  value: es.caib.notib.plugin.dades.usuari.pluginsib.userinformation.keycloak.realm
              - column:
                  name: value
                  value:
              - column:
                  name: description
                  value: Realm del keycloak
              - column:
                  name: group_code
                  value: USUARIS
              - column:
                  name: position
                  value: 7
              - column:
                  name: jboss_property
                  value: ${booleanTrue}
              - column:
                  name: type_code
                  value: TEXT
              - column:
                  name: configurable
                  value: ${booleanFalse}
        - insert:
            tableName: not_config
            columns:
              - column:
                  name: key
                  value: es.caib.notib.plugin.dades.usuari.pluginsib.userinformation.keycloak.client_id
              - column:
                  name: value
                  value:
              - column:
                  name: description
                  value: Client ID del keycloak
              - column:
                  name: group_code
                  value: USUARIS
              - column:
                  name: position
                  value: 8
              - column:
                  name: jboss_property
                  value: ${booleanTrue}
              - column:
                  name: type_code
                  value: TEXT
              - column:
                  name: configurable
                  value: ${booleanFalse}
        - insert:
            tableName: not_config
            columns:
              - column:
                  name: key
                  value: es.caib.notib.plugin.dades.usuari.pluginsib.userinformation.keycloak.client_id_for_user_autentication
              - column:
                  name: value
                  value:
              - column:
                  name: description
                  value: Client ID per autenticació del keycloak
              - column:
                  name: group_code
                  value: USUARIS
              - column:
                  name: position
                  value: 9
              - column:
                  name: jboss_property
                  value: ${booleanTrue}
              - column:
                  name: type_code
                  value: TEXT
              - column:
                  name: configurable
                  value: ${booleanFalse}
        - insert:
            tableName: not_config
            columns:
              - column:
                  name: key
                  value: es.caib.notib.plugin.dades.usuari.pluginsib.userinformation.keycloak.password_secret
              - column:
                  name: value
                  value:
              - column:
                  name: description
                  value: Secret del client de keycloak
              - column:
                  name: group_code
                  value: USUARIS
              - column:
                  name: position
                  value: 10
              - column:
                  name: jboss_property
                  value: ${booleanTrue}
              - column:
                  name: type_code
                  value: TEXT
              - column:
                  name: configurable
                  value: ${booleanFalse}
        - insert:
            tableName: not_config
            columns:
              - column:
                  name: key
                  value: es.caib.notib.plugin.dades.usuari.pluginsib.userinformation.keycloak.mapping.administrationID
              - column:
                  name: value
                  value: NIF
              - column:
                  name: description
                  value: Mapeig del administrationID de keycloak
              - column:
                  name: group_code
                  value: USUARIS
              - column:
                  name: position
                  value: 11
              - column:
                  name: jboss_property
                  value: ${booleanFalse}
              - column:
                  name: type_code
                  value: TEXT
              - column:
                  name: configurable
                  value: ${booleanFalse}
        - insert:
            tableName: not_config
            columns:
              - column:
                  name: key
                  value: es.caib.notib.plugin.dades.usuari.pluginsib.userinformation.keycloak.debug
              - column:
                  name: value
                  value: false
              - column:
                  name: description
                  value: Activar el debug del plugin de keycloak
              - column:
                  name: group_code
                  value: USUARIS
              - column:
                  name: position
                  value: 12
              - column:
                  name: jboss_property
                  value: ${booleanFalse}
              - column:
                  name: type_code
                  value: BOOL
              - column:
                  name: configurable
                  value: ${booleanFalse}
        - sql: "
              UPDATE NOT_CONFIG_TYPE SET VALUE = 'es.caib.notib.plugin.usuari.DadesUsuariPluginJdbc,es.caib.notib.plugin.usuari.DadesUsuariPluginLdap,es.caib.notib.plugin.usuari.DadesUsuariPluginMock,es.caib.notib.plugin.usuari.DadesUsuariPluginKeycloak' WHERE CODE = 'USUARIS_CLASS';
              UPDATE NOT_CONFIG SET VALUE = 'es.caib.notib.plugin.usuari.DadesUsuariPluginKeycloak' WHERE KEY = 'es.caib.notib.plugin.dades.usuari.class';
              GRANT SELECT, UPDATE, INSERT, DELETE ON NOT_GUARD TO WWW_NOTIB;
              GRANT SELECT, UPDATE, INSERT, DELETE ON NOT_ACTION TO WWW_NOTIB;
              GRANT SELECT, UPDATE, INSERT, DELETE ON NOT_DEFERRED_EVENTS TO WWW_NOTIB;
              GRANT SELECT, UPDATE, INSERT, DELETE ON NOT_STATE TO WWW_NOTIB;
              GRANT SELECT, UPDATE, INSERT, DELETE ON NOT_STATE_ENTRY_ACTIONS TO WWW_NOTIB;
              GRANT SELECT, UPDATE, INSERT, DELETE ON NOT_STATE_EXIT_ACTIONS TO WWW_NOTIB;
              GRANT SELECT, UPDATE, INSERT, DELETE ON NOT_STATE_MACHINE TO WWW_NOTIB;
              GRANT SELECT, UPDATE, INSERT, DELETE ON NOT_STATE_STATE_ACTIONS TO WWW_NOTIB;
              GRANT SELECT, UPDATE, INSERT, DELETE ON NOT_TRANSITION TO WWW_NOTIB;
              GRANT SELECT, UPDATE, INSERT, DELETE ON NOT_TRANSITION_ACTIONS TO WWW_NOTIB;
              
              CREATE SYNONYM action FOR not_action;
              CREATE SYNONYM guard FOR not_guard;
              CREATE SYNONYM state FOR not_state;
              CREATE SYNONYM state_machine FOR not_state_machine;
              CREATE SYNONYM transition FOR not_transition;
              CREATE SYNONYM deferred_events FOR not_deferred_events;
              CREATE SYNONYM state_entry_actions FOR not_state_entry_actions;
              CREATE SYNONYM state_exit_actions FOR not_state_exit_actions;
              CREATE SYNONYM state_state_actions FOR not_state_state_actions;
              CREATE SYNONYM transition_actions FOR not_transition_actions;
             "