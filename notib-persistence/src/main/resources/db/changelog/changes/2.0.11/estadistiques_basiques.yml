databaseChangeLog:
  - changeSet:
      id: modify-columns-not-explot-fet
      author: user
      changes:
        - modifyDataType:
            columnName: TOT_PENDENT
            tableName: NOT_EXPLOT_FET
            newDataType: NULL
        - modifyDataType:
            columnName: TOT_REG_ERR
            tableName: NOT_EXPLOT_FET
            newDataType: NULL
        - modifyDataType:
            columnName: TOT_REGISTR
            tableName: NOT_EXPLOT_FET
            newDataType: NULL
        - modifyDataType:
            columnName: TOT_SIR_ACC
            tableName: NOT_EXPLOT_FET
            newDataType: NULL
        - modifyDataType:
            columnName: TOT_SIR_REB
            tableName: NOT_EXPLOT_FET
            newDataType: NULL
        - modifyDataType:
            columnName: TOT_NOT_ERR
            tableName: NOT_EXPLOT_FET
            newDataType: NULL
        - modifyDataType:
            columnName: TOT_NOT_ENV
            tableName: NOT_EXPLOT_FET
            newDataType: NULL
        - modifyDataType:
            columnName: TOT_NOT_NOT
            tableName: NOT_EXPLOT_FET
            newDataType: NULL
        - modifyDataType:
            columnName: TOT_NOT_REB
            tableName: NOT_EXPLOT_FET
            newDataType: NULL
        - modifyDataType:
            columnName: TOT_NOT_EXP
            tableName: NOT_EXPLOT_FET
            newDataType: NULL
        - modifyDataType:
            columnName: TOT_CIE_ERR
            tableName: NOT_EXPLOT_FET
            newDataType: NULL
        - modifyDataType:
            columnName: TOT_CIE_ENV
            tableName: NOT_EXPLOT_FET
            newDataType: NULL
        - modifyDataType:
            columnName: TOT_CIE_NOT
            tableName: NOT_EXPLOT_FET
            newDataType: NULL
        - modifyDataType:
            columnName: TOT_CIE_REB
            tableName: NOT_EXPLOT_FET
            newDataType: NULL
        - modifyDataType:
            columnName: TOT_CIE_FAL
            tableName: NOT_EXPLOT_FET
            newDataType: NULL
        - modifyDataType:
            columnName: TOT_PROCESS
            tableName: NOT_EXPLOT_FET
            newDataType: NULL

  - changeSet:
      id: add-calculated-columns
      author: user
      changes:
        - addColumn:
            tableName: NOT_NOTIFICACIO_TABLE
            columns:
              - column:
                  name: CREATED_DIA
                  type: VARCHAR(255)
                  defaultValueComputed: "TRUNC(CREATEDDATE)"
        - addColumn:
            tableName: NOT_NOTIFICACIO_TABLE
            columns:
              - column:
                  name: ENVIADA_DIA
                  type: VARCHAR(255)
                  defaultValueComputed: "TRUNC(ENVIADA_DATE)"
        - addColumn:
            tableName: NOT_NOTIFICACIO_ENV_TABLE
            columns:
              - column:
                  name: REGISTRE_DIA
                  type: VARCHAR(255)
                  defaultValueComputed: "TRUNC(REGISTRE_DATA)"
        - addColumn:
            tableName: NOT_NOTIFICACIO_ENV
            columns:
              - column:
                  name: ESTAT_DIA
                  type: VARCHAR(255)
                  defaultValueComputed: "TRUNC(NOTIFICA_ESTAT_DATAACT)"
              - column:
                  name: ESTAT_NOM
                  type: VARCHAR(255)
                  defaultValueComputed: "CASE WHEN NOTIFICA_ESTAT = 0 THEN 'PENDENT' WHEN NOTIFICA_ESTAT = 10 THEN 'EXPIRADA' WHEN NOTIFICA_ESTAT IN (13, 14) THEN 'NOTIFICADA' WHEN NOTIFICA_ESTAT = 20 THEN 'REBUTJADA' WHEN NOTIFICA_ESTAT = 24 THEN 'PEND_ENV' WHEN NOTIFICA_ESTAT IN (2, 3, 9, 11, 12, 21) THEN 'NOT_ERR' ELSE 'ALTRES' END"
              - column:
                  name: SIR_DIA
                  type: VARCHAR(255)
                  defaultValueComputed: "TRUNC(SIR_REC_DATA)"
              - column:
                  name: SIR_ESTAT
                  type: VARCHAR(255)
                  defaultValueComputed: "CASE WHEN ESTAT_REGISTRE = 9 THEN 'REBUTJADA' WHEN ESTAT_REGISTRE = 5 THEN 'NOTIFICADA' ELSE 'ALTRES' END"

  - changeSet:
      id: create-indexes
      author: user
      changes:
        - createIndex:
            tableName: NOT_NOTIFICACIO_TABLE
            indexName: NOT_CREATED_DIA_I
            columns:
              - column:
                  name: CREATED_DIA
        - createIndex:
            tableName: NOT_NOTIFICACIO_TABLE
            indexName: NOT_ENVIADA_DIA_I
            columns:
              - column:
                  name: ENVIADA_DIA
        - createIndex:
            tableName: NOT_NOTIFICACIO_ENV_TABLE
            indexName: NOT_REGISTRE_DIA_I
            columns:
              - column:
                  name: REGISTRE_DIA
        - createIndex:
            tableName: NOT_NOTIFICACIO_ENV
            indexName: NOT_ESTAT_DIA_I
            columns:
              - column:
                  name: ESTAT_DIA
        - createIndex:
            tableName: NOT_NOTIFICACIO_ENV
            indexName: NOT_ESTAT_I
            columns:
              - column:
                  name: ESTAT_NOM
        - createIndex:
            tableName: NOT_NOTIFICACIO_ENV
            indexName: NOT_SIR_DIA_I
            columns:
              - column:
                  name: SIR_DIA
        - createIndex:
            tableName: NOT_NOTIFICACIO_ENV
            indexName: NOT_SIR_ESTAT_I
            columns:
              - column:
                  name: SIR_ESTAT

  - changeSet:
      id: create-views
      author: user
      changes:
        - createView:
            viewName: NOT_CREADES_ENVIADES_VIEW
            selectQuery: |
              WITH notificacions AS (
                  SELECT
                      nt.entitat_id,
                      n.procediment_id,
                      o.codi AS organ_codi,
                      nt.usuari_codi,
                      nt.env_tipus,
                      n.origen,
                      nt.CREATED_DIA,
                      nt.ENVIADA_DIA
                  FROM NOT_NOTIFICACIO_TABLE nt
                  JOIN NOT_NOTIFICACIO n ON nt.id = n.id
                  JOIN NOT_ORGAN_GESTOR o ON n.organ_gestor = o.id
                  WHERE nt.CREATED_DIA IS NOT NULL OR nt.ENVIADA_DIA IS NOT NULL
              )
              SELECT entitat_id, procediment_id, organ_codi, usuari_codi, env_tipus, origen, 'CREADA' AS tipus, CREATED_DIA AS dia, COUNT(*) AS total
              FROM notificacions
              WHERE CREATED_DIA IS NOT NULL
              GROUP BY entitat_id, procediment_id, organ_codi, usuari_codi, env_tipus, origen, CREATED_DIA
              UNION ALL
              SELECT entitat_id, procediment_id, organ_codi, usuari_codi, env_tipus, origen, 'ENVIADA' AS tipus, ENVIADA_DIA AS dia, COUNT(*) AS total
              FROM notificacions
              WHERE ENVIADA_DIA IS NOT NULL
              GROUP BY entitat_id, procediment_id, organ_codi, usuari_codi, env_tipus, origen, ENVIADA_DIA

        - createView:
            viewName: NOT_REGISTRADES_VIEW
            selectQuery: |
              WITH notificacions AS (
                  SELECT
                      et.entitat_id,
                      n.procediment_id,
                      o.codi as organ_codi,
                      et.usuari_codi,
                      et.tipus_enviament as env_tipus,
                      n.origen,
                      et.REGISTRE_DIA
                  FROM NOT_NOTIFICACIO_ENV_TABLE et
                  JOIN NOT_NOTIFICACIO n ON et.notificacio_id = n.id
                  JOIN NOT_ORGAN_GESTOR o ON n.organ_gestor = o.id
                  WHERE et.REGISTRE_DIA IS NOT NULL
              )
              SELECT entitat_id, procediment_id, organ_codi, usuari_codi, env_tipus, origen, 'REGISTRADA' AS tipus, REGISTRE_DIA AS dia, COUNT(*) AS total
              FROM notificacions
              WHERE REGISTRE_DIA IS NOT NULL
              GROUP BY entitat_id, procediment_id, organ_codi, usuari_codi, env_tipus, origen, REGISTRE_DIA;

        - createView:
            viewName: NOT_ESTAT_VIEW
            selectQuery: |
              WITH notificacions AS (
                  SELECT
                      n.entitat_id,
                      n.procediment_id,
                      o.codi as organ_codi,
                      n.usuari_codi,
                      n.env_tipus,
                      n.origen,
                      e.ESTAT_NOM as estat,
                      nt.error_last_event as error,
                      e.ESTAT_DIA
                  FROM NOT_NOTIFICACIO_ENV e
                  JOIN NOT_NOTIFICACIO n ON e.notificacio_id = n.id
                  JOIN NOT_NOTIFICACIO_TABLE nt ON nt.id = n.id
                  JOIN NOT_ORGAN_GESTOR o ON n.organ_gestor = o.id
                  WHERE et.REGISTRE_DIA IS NOT NULL
              )
              SELECT entitat_id, procediment_id, organ_codi, usuari_codi, env_tipus, origen, CASE WHEN error = 1 AND estat = 'PENDENT' THEN 'REG_ERR' WHEN error = 1 AND estat = 'PEND_ENV' THEN 'ENV_ERR' ELSE estat END AS tipus, ESTAT_DIA AS dia, COUNT(*) AS total
              FROM notificacions
              WHERE ESTAT_DIA IS NOT NULL
              GROUP BY entitat_id, procediment_id, organ_codi, usuari_codi, env_tipus, origen, estat, error, ESTAT_DIA;

        - createView:
            viewName: NOT_SIR_VIEW
            selectQuery: |
              WITH notificacions AS (
                  SELECT
                      n.entitat_id,
                      n.procediment_id,
                      o.codi as organ_codi,
                      n.usuari_codi,
                      n.env_tipus,
                      n.origen,
                      e.SIR_ESTAT as estat,
                      e.SIR_DIA
                  FROM NOT_NOTIFICACIO_ENV e
                  JOIN NOT_NOTIFICACIO_ENV_TABLE et on et.id = e.id
                  JOIN NOT_NOTIFICACIO n ON e.notificacio_id = n.id
                  JOIN NOT_ORGAN_GESTOR o ON n.organ_gestor = o.id
                  WHERE e.SIR_DIA IS NOT NULL AND e.registre_estat_final = 1
              )
              SELECT entitat_id, procediment_id, organ_codi, usuari_codi, env_tipus, origen, estat AS tipus, SIR_DIA AS dia, COUNT(*) AS total
              FROM notificacions
              WHERE SIR_DIA IS NOT NULL
              GROUP BY entitat_id, procediment_id, organ_codi, usuari_codi, env_tipus, origen, estat, SIR_DIA;

        - createView:
            viewName: NOT_STATS_VIEW
            selectQuery: |
              SELECT entitat_id, procediment_id, organ_codi, usuari_codi, env_tipus, origen, tipus, dia, total FROM NOT_CREADES_ENVIADES_VIEW
              UNION ALL
              SELECT entitat_id, procediment_id, organ_codi, usuari_codi, env_tipus, origen, tipus, dia, total FROM NOT_REGISTRADES_VIEW
              UNION ALL
              SELECT entitat_id, procediment_id, organ_codi, usuari_codi, env_tipus, origen, tipus, dia, total FROM NOT_ESTAT_VIEW
              UNION ALL
              SELECT entitat_id, procediment_id, organ_codi, usuari_codi, env_tipus, origen, tipus, dia, total FROM NOT_SIR_VIEW;
